<HTML>
  <HEAD>
    <meta charset="utf-8">
    <TITLE>Авторизация</TITLE>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/60c6536c6a.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script>
      if (localStorage.getItem('isLogIn')) {
        window.location="to do list.html";
      }
    </script>
    <link rel="stylesheet" type="text/css" href="./css/style.css">
  </HEAD>
  <BODY>
    <div id="bgBlurLt">
      <img src="">
    </div>
    <div id="loadingScreen">
      <div id="loadingContent">
        <img id="loadingImage">
      </div>
    </div>
    <div class="content-container padding-container">
      <div style="padding-top: 25px;" class="form-group">
        <label for="exampleInputEmail1">E-mail</label>
        <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" autocomplete="on" placeholder="Введите E-mail">
      </div>
      <div class="form-group">
        <label for="exampleInputPassword1">Пароль</label>
        <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Введите пароль">
      </div>
      <div id="errorMessage" style="color: #f80000; margin-bottom: 15px;"></div>
      <div style="width: 100%; padding-bottom: 25px; display: flex; justify-content: center;">
        <button style="margin-right: 5px" type="submit" class="btn btn-primary" onclick="auth()">Войти</button>
        <a class="btn btn-outline-primary" role="button" href="registration.html">Зарегистрироваться</a>
      </div>
    </div>
    </script>
    <script src="./js/beautifie.js"></script>
  <SCRIPT>
    if (localStorage.getItem('theme') === 'dark') {
      $('.content-container').css({
        'background-color': '#252527',
        'color': 'white'
      });
      $('.form-control').css({
        'background-color': 'rgba(0,0,0,.5)',
        'color': 'white'
      })
    }
    document.querySelector('#exampleInputPassword1').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        this.blur();
        auth();
      }
    });

    $('.form-control').focus(function(){
      $('.form-control').css('border-color', '');
      $('#errorMessage').text('');
    });
      
    //function setCookie(name, value, options) {
    //  options = options || {};
//
    //  var expires = options.expires;
//
    //  if (typeof expires == "number" && expires) {
    //    var d = new Date();
    //    d.setTime(d.getTime() + expires * 1000);
    //    expires = options.expires = d;
    //  }
    //  if (expires && expires.toUTCString) {
    //    options.expires = expires.toUTCString();
    //  }
//
    //  value = encodeURIComponent(value);
//
    //  var updatedCookie = name + "=" + value;
//
    //  for (var propName in options) {
    //    updatedCookie += "; " + propName;
    //    var propValue = options[propName];
    //    if (propValue !== true) {
    //      updatedCookie += "=" + propValue;
    //    }
    //  }
//
    //  document.cookie = updatedCookie;
    //}

    function setCookie(name, value){
      var cookie_string = name + "=" + String(value);

      var expires = new Date ();
      expires.setDate(expires.getDate() + 7);
      cookie_string += "; expires=" + expires.toUTCString();

      document.cookie = cookie_string;
    }

    var userData;

    function auth(){
      var user = {
        userName: document.getElementById("exampleInputEmail1").value,
        password: document.getElementById("exampleInputPassword1").value
      }
      $.ajax({
          url: "http://localhost:3000/users/login?userName=" + user.userName + "&password=" +  user.password,
          type: 'GET',
          crossDomain: true,
          dataType: 'jsonp',
          contentType: 'application/json; charset=utf-8',
          success: function (data) {
            setCookie('isLogIn', true);
            setCookie('user', JSON.stringify(data));
            localStorage.setItem('isLogIn', true);
            userData = {
              firstName: data.firstName,
              lastName: data.lastName,
              surName: data.surName,
              email: data.email
            }
            localStorage.setItem('user', JSON.stringify(userData));
            var searchParams = new URLSearchParams(window.location.search);
            var location = searchParams.get('redirectedFrom');
            if (location) {
              window.location = String(location);
            }else{
              window.location.replace('to do list.html');
            }
          },
          error: function () {
            $('#exampleInputEmail1').css('border-color', '#f80000');
            $('#exampleInputPassword1').css('border-color', '#f80000');
            $('#errorMessage').text('Неверное имя пользователя или пароль!');
          }
      });
    }
  </SCRIPT>
  </BODY>
</HTML> 
